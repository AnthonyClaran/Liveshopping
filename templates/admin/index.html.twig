{% extends 'admin/baseAdmin.html.twig' %}


{% block title %}Dasboard{% endblock %}
{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/dashboard.css') }}">
{% endblock %}

{% block content %}
    <div class="modern-dashboard">
        <!-- Filtres modernes -->
        <div class="filter-card">
            <form action="{{ path('app_dashboard') }}" method="post">
                <div class="filter-group">
                    <label for="dateD" data-i18n="period">Période</label>
                    <div class="date-range">
                        <input type="date" name="dateD" id="dateD" required class="modern-input">
                        <span class="date-separator">—</span>
                        <input type="date" name="dateF" id="dateF" required class="modern-input">
                    </div>
                </div>

                <div class="filter-group">
                    <label for="category" data-i18n="category">Catégorie</label>
                    <select name="category" id="category" required class="modern-select">
                        {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.nameCategory }}</option>
                        {% endfor %}
                    </select>
                </div>

                <button type="submit" class="modern-button">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span data-i18n="apply">Appliquer</span>
                </button>
            </form>
        </div>

        <!-- Graphiques avec style moderne -->
        <div class="chart-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 data-i18n="revenue">Chiffre d'affaires</h3>
                    <span class="chart-badge" data-i18n="monthly">Mensuel</span>
                </div>
                <canvas id="salesChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3 data-i18n="trends">Tendances</h3>
                    <span class="chart-badge" data-i18n="by_category">Par catégorie</span>
                </div>
                <canvas id="trendsChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3 data-i18n="distribution">Répartition</h3>
                    <span class="chart-badge" data-i18n="sales">Ventes</span>
                </div>
                <canvas id="cheeseChart"></canvas>
            </div>
        </div>

        <!-- Synthèse globale -->
        <div class="summary-section">
            <div class="summary-card" style="
                background: linear-gradient(135deg, #2c3e50, #4ca1af);
                color: #fff;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 6px 15px rgba(0,0,0,0.2);
                text-align: center;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            ">
                <div class="icon-wrapper" style="
                background: rgba(255,255,255,0.15);
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                margin: 0 auto 15px;
                ">
                    <i class="fas fa-chart-line fa-lg"></i>
                </div>
                <h4 style="margin-bottom: 10px; font-size: 1.2rem;">
                    <i class="fas fa-chart-pie"></i> <span data-i18n="total_turnover">Total turnover</span>
                </h4>
                <p style="font-size: 1.3rem; font-weight: bold;">
                    {{ stats.ca_total|number_format(0, ',', ' ') }} €
                </p>
            </div>

            <div class="summary-card" style="
                background: linear-gradient(135deg, #ff7e5f, #feb47b);
                color: #fff;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 6px 15px rgba(0,0,0,0.2);
                text-align: center;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            ">
                <div class="icon-wrapper" style="
                    background: rgba(255,255,255,0.15);
                    width: 50px;
                    height: 50px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                    margin: 0 auto 15px;
                ">
                    <i class="fas fa-shopping-cart fa-lg"></i>
                </div>
                <h4 style="margin-bottom: 10px; font-size: 1.2rem;">
                    <i class="fas fa-tag"></i> <span data-i18n="total_sales">Total sales</span>
                </h4>
                <p>{{ stats.ventes_total }}</p>
            </div>

            <div class="summary-card" style="
                background: linear-gradient(135deg, #8e2de2, #4a00e0);
                color: #fff;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 6px 15px rgba(0,0,0,0.2);
                text-align: center;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            ">
                <div class="icon-wrapper" style="
                    background: rgba(255,255,255,0.15);
                    width: 50px;
                    height: 50px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                    margin: 0 auto 15px;
                ">
                    <i class="fas fa-shopping-basket fa-lg"></i>
                </div>
                <h4 style="margin-bottom: 10px; font-size: 1.2rem;">
                    <i class="fas fa-calculator"></i> <span data-i18n="average_bag">Average bag</span>
                </h4>
                <p>
                    {% if stats.ventes_total > 0 %}
                        {{ (stats.ca_total / stats.ventes_total)|number_format(2, ',', ' ') }} €
                    {% else %}
                        0 €
                    {% endif %}
                </p>
            </div>

            <div class="summary-card" style="
            background: linear-gradient(135deg, #43cea2, #185a9d);
            color: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        ">
            <div class="icon-wrapper" style="
                background: rgba(255,255,255,0.15);
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                margin: 0 auto 15px;
            ">
                <i class="fas fa-star fa-lg"></i>
            </div>
            <h4 style="margin-bottom: 10px; font-size: 1.2rem;">
                <i class="fas fa-trophy"></i> <span data-i18n="best_category">Best category</span>
            </h4>
            <p>{{ stats.meilleure_categorie ?? 'N/A' }}</p>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Couleurs modernes
            const colors = {
                primary: '#4361ee',
                secondary: '#3a0ca3',
                accent: '#f72585',
                gray: '#4a5568',
                lightGray: '#e2e8f0'
            };

            // Données des graphiques
            const statsMensuelles = {{ stats|json_encode|raw }};
            const ventesParCategorieParMois = {{ ventesParCategorieParMois|json_encode|raw }};
            const ventesParArticle = {{ ventesParArticle|json_encode|raw }};

            // Graphique CA mensuel
            new Chart(document.getElementById('salesChart'), {
                type: 'bar',
                data: {
                    labels: statsMensuelles.labels.length > 0 ? statsMensuelles.labels : ['Aucune donnée'],
                    datasets: [{
                        label: 'CA (€)',
                        data: statsMensuelles.chiffre_affaires.length > 0 ? statsMensuelles.chiffre_affaires : [0],
                        backgroundColor: colors.primary,
                        borderColor: colors.secondary,
                        borderWidth: 0,
                        borderRadius: 6
                    }]
                },
                options: getChartOptions('Chiffre d\'affaires mensuel')
            });

            // Graphique tendances
            const categoryColors = [
                colors.primary,
                colors.accent,
                '#7209b7',
                '#3a86ff',
                colors.gray
            ];

            new Chart(document.getElementById('trendsChart'), {
                type: 'line',
                data: {
                    labels: ventesParCategorieParMois.labels.length > 0 ? ventesParCategorieParMois.labels : ['Aucune donnée'],
                    datasets: Object.entries(ventesParCategorieParMois.datasets || {}).map(([cat, data], index) => ({
                        label: cat,
                        data: data,
                        borderColor: categoryColors[index % categoryColors.length],
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        tension: 0.3,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }))
                },
                options: getChartOptions('Ventes par catégorie')
            });

            // Graphique répartition
            const cheeseData = ventesParArticle && ventesParArticle.datasets
                ? Object.entries(ventesParArticle.datasets).map(([label, data]) => ({
                    label: label,
                    data: Array.isArray(data) ? data.reduce((a, b) => a + b, 0) : 0
                }))
                : [{ label: 'Aucune donnée', data: 1 }];

            new Chart(document.getElementById('cheeseChart'), {
                type: 'doughnut',
                data: {
                    labels: cheeseData.map(item => item.label),
                    datasets: [{
                        data: cheeseData.map(item => item.data),
                        backgroundColor: [
                            colors.primary,
                            colors.accent,
                            '#7209b7',
                            '#3a86ff',
                            colors.gray
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    ...getChartOptions('Répartition des ventes'),
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Options communes des graphiques
            function getChartOptions(title) {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: '#2d3748',
                            titleColor: '#fff',
                            bodyColor: '#e2e8f0',
                            borderColor: '#4a5568',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: true,
                            usePointStyle: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: colors.lightGray,
                                drawBorder: false
                            },
                            ticks: {
                                color: colors.gray
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: colors.gray
                            }
                        }
                    },
                    elements: {
                        line: {
                            fill: false
                        }
                    }
                };
            }
        });
    </script>
{% endblock %}
